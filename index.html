<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Irrigation System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    nav {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      background: #4CAF50;
      color: white;
    }

    .nav-links a {
      color: white;
      margin-right: 15px;
      text-decoration: none;
    }

    .weather-feed-container {
      background: #e8f5e8;
      padding: 10px;
      text-align: center;
    }

    .arduino-connection {
      background: #1976D2;
      color: white;
      padding: 20px;
      margin: 20px;
      border-radius: 8px;
      max-width: 400px;
    }

    .connection-input {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .connection-input input {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: none;
    }

    .connection-input button {
      padding: 8px 15px;
      background: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .arduino-status {
      margin-top: 10px;
    }

    .reading-panel {
      background: #4CAF50;
      color: white;
      padding: 20px;
      margin: 20px;
      border-radius: 8px;
      max-width: 400px;
    }

    .reading-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .control-container {
      margin: 20px;
    }

    .status-message {
      margin: 20px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f8d7da;
      color: #721c24;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .connected {
      background: #d4edda;
      color: #155724;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #4CAF50;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }
  </style>
</head>

<body>

  <!-- âœ… Connection Status -->
  <div class="connection-status" id="connectionStatus">ðŸ”´ Server Disconnected</div>

  <!-- âœ… Navigation -->
  <nav>
    <div class="nav-links">
      <a href="#">Home</a>
      <a href="#">Dashboard</a>
    </div>
    <div>Smart Irrigation</div>
  </nav>

  <!-- âœ… Weather Feed -->
  <div class="weather-feed-container">
    <span id="weatherText">Live weather feed from Ilorin â€¢ Temp: --Â°C â€¢ Humidity: --%</span>
  </div>

  <!-- âœ… Arduino Connection -->
  <div class="arduino-connection">
    <h3>Connect to Arduino</h3>
    <div class="connection-input">
      <input type="text" id="arduinoIP" placeholder="192.168.4.1" />
      <button onclick="connectToArduino()">Connect</button>
    </div>
    <div class="arduino-status" id="arduinoStatus">ðŸ”´ Not connected to Arduino</div>
  </div>

  <!-- âœ… Readings -->
  <div class="reading-panel">
    <h3>Arduino Sensor Readings</h3>
    <div class="reading-item"><span>Temperature</span><span id="sensor-temp">--Â°C</span></div>
    <div class="reading-item"><span>Humidity</span><span id="sensor-humidity">--%</span></div>
    <div class="reading-item"><span>Soil Moisture</span><span id="sensor-moisture">--</span></div>
    <div class="reading-item"><span>Threshold</span><span id="sensor-threshold">--</span></div>
  </div>

  <!-- âœ… Controls -->
  <div class="control-container">
    <label class="switch">
      <input type="checkbox" id="irrigationToggle">
      <span class="slider"></span>
    </label>
    <p class="status-message" id="statusMessage">Connect to Arduino to see pump status</p>
  </div>

  <!-- âœ… Script -->
  <script>
    const API_BASE_URL = 'https://smartirrigation-edx5.onrender.com/api';

    let arduinoIP = '';
    let arduinoConnected = false;

    async function fetchArduinoData() {
      if (!arduinoIP) return;
      try {
        const res = await fetch(`http://${arduinoIP}/api/data`);
        const data = await res.json();
        updateArduinoDisplay(data);
        updateArduinoStatus(true, 'Connected to Arduino');
      } catch (err) {
        console.error('Arduino fetch failed:', err);
        updateArduinoStatus(false, 'Failed to connect to Arduino');
      }
    }

    function connectToArduino() {
      const ipInput = document.getElementById('arduinoIP');
      arduinoIP = ipInput.value.trim();
      if (!arduinoIP) {
        updateArduinoStatus(false, 'Please enter IP');
        return;
      }
      if (!/^\d{1,3}(\.\d{1,3}){3}$/.test(arduinoIP)) {
        updateArduinoStatus(false, 'Invalid IP format');
        return;
      }
      localStorage.setItem('arduinoIP', arduinoIP);
      updateArduinoStatus(false, 'Connecting...');
      fetchArduinoData();
    }

    function updateArduinoDisplay(data) {
      document.getElementById('sensor-temp').textContent = data.temperature + 'Â°C';
      document.getElementById('sensor-humidity').textContent = data.humidity + '%';
      document.getElementById('sensor-moisture').textContent = data.moisture;
      document.getElementById('sensor-threshold').textContent = data.threshold;

      const statusMessage = document.getElementById('statusMessage');
      if (data.pumpActive) {
        statusMessage.textContent = 'Arduino Pump: ACTIVE';
        statusMessage.style.background = '#d4edda';
      } else {
        statusMessage.textContent = 'Arduino Pump: OFF';
        statusMessage.style.background = '#f8d7da';
      }
    }

    function updateArduinoStatus(connected, msg) {
      const status = document.getElementById('arduinoStatus');
      arduinoConnected = connected;
      status.textContent = (connected ? 'ðŸŸ¢ ' : 'ðŸ”´ ') + msg;
    }

    function updateConnectionStatus(connected) {
      const cs = document.getElementById('connectionStatus');
      cs.textContent = connected ? 'ðŸŸ¢ Server Connected' : 'ðŸ”´ Server Disconnected';
      cs.className = connected ? 'connection-status connected' : 'connection-status';
    }

    async function fetchSensorData() {
      try {
        const res = await fetch(`${API_BASE_URL}/sensors/data`);
        const data = await res.json();
        if (data.success) {
          const wind = (10 + Math.random() * 5).toFixed(1);
          document.getElementById('weatherText').textContent =
            `Live weather feed from Ilorin â€¢ Temp: ${data.sensorData.temperature}Â°C â€¢ Humidity: ${data.sensorData.humidity}% â€¢ Wind: ${wind} km/h`;
          updateConnectionStatus(true);
        }
      } catch (err) {
        updateConnectionStatus(false);
      }
    }

    // Load saved Arduino IP
    document.addEventListener('DOMContentLoaded', () => {
      const savedIP = localStorage.getItem('arduinoIP');
      if (savedIP) {
        document.getElementById('arduinoIP').value = savedIP;
        arduinoIP = savedIP;
        fetchArduinoData();
      }
      fetchSensorData();
      setInterval(fetchSensorData, 5000);
      setInterval(fetchArduinoData, 5000);
    });
  </script>

</body>

</html>